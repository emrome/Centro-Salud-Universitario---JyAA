import{a as he}from"./chunk-MPOD3TBQ.js";import{a as k}from"./chunk-ULAKRKGX.js";import{a as T}from"./chunk-T5CJBDVT.js";import{a as ee}from"./chunk-VWLE3RA7.js";import{b as le,c as I,d as de,e as A,g as X,i as D,j as pe,n as ce,p as O,r as S}from"./chunk-4ZEEV3KU.js";import{b as K,d as z,h as L,i as _}from"./chunk-OLTWCF2P.js";import{$a as p,Ea as f,Ja as g,Ob as J,Pb as w,Qa as d,Ra as U,Sb as b,Ta as N,Ua as r,V as me,Va as n,W as C,Wa as u,X as x,Za as E,_a as h,bb as H,ca as Q,cb as W,db as Y,hb as m,ib as v,jb as Z,ua as s,ya as c}from"./chunk-ILAX3XGE.js";import{a as P,b as re,d as ae,e as se}from"./chunk-FDERIQAA.js";var M=ae(he());var fe=["mapEl"],V=class i{coordinates=[];height="160px";width="100%";mapEl;map=null;polygon=null;io;shouldInit=!0;ngAfterViewInit(){this.io=new IntersectionObserver(t=>{t.some(o=>o.isIntersecting)&&this.shouldInit&&(this.initMap(),this.shouldInit=!1)},{rootMargin:"200px"}),this.io.observe(this.mapEl.nativeElement)}ngOnChanges(t){if(t.coordinates){if(!this.map&&this.coordinates&&this.coordinates.length>=3&&this.mapEl?.nativeElement){this.initMap(),this.shouldInit=!1;return}this.map&&this.polygon&&this.updatePolygon()}}ngOnDestroy(){this.io?.disconnect(),this.map&&(this.map.remove(),this.map=null)}initMap(){!this.coordinates||this.coordinates.length<3||(this.map=M.map(this.mapEl.nativeElement,{zoomControl:!1,attributionControl:!1,dragging:!1,doubleClickZoom:!1,scrollWheelZoom:!1,boxZoom:!1,keyboard:!1,touchZoom:!1,preferCanvas:!0}),M.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,detectRetina:!1,noWrap:!0}).addTo(this.map),this.polygon=M.polygon(this.coordinates,{weight:2}),this.polygon.addTo(this.map),this.fitBounds(),setTimeout(()=>this.map?.invalidateSize(),0))}updatePolygon(){this.map&&(this.polygon?this.polygon.setLatLngs(this.coordinates):this.polygon=M.polygon(this.coordinates,{weight:2}).addTo(this.map),this.fitBounds())}fitBounds(){if(!this.map||!this.polygon)return;let t=this.polygon.getBounds();this.map.fitBounds(t,{padding:[10,10],maxZoom:16})}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=f({type:i,selectors:[["app-map-polygon-preview"]],viewQuery:function(e,o){if(e&1&&H(fe,7),e&2){let a;W(a=Y())&&(o.mapEl=a.first)}},inputs:{coordinates:"coordinates",height:"height",width:"width"},features:[me],decls:3,vars:4,consts:[["mapEl",""],[1,"preview-wrapper"],[1,"preview-host"]],template:function(e,o){e&1&&(r(0,"div",1),u(1,"div",2,0),n()),e&2&&U("height",o.height)("width",o.width)},dependencies:[b],styles:[".preview-wrapper[_ngcontent-%COMP%]{border-radius:8px;overflow:hidden;box-shadow:0 0 0 1px #0000000f,0 2px 8px #0000000f}.preview-host[_ngcontent-%COMP%]{height:100%;width:100%}"]})};function be(i,t){if(i&1&&(r(0,"p",8),m(1,"Descripci\xF3n:"),n(),r(2,"div",9),m(3),n()),i&2){let e=p().$implicit;s(3),v(e.description)}}function ve(i,t){if(i&1&&u(0,"app-map-polygon-preview",7),i&2){let e=p().$implicit;d("coordinates",e.coordinates)}}function ye(i,t){i&1&&(r(0,"p",8),m(1,"No hay coordenadas definidas."),n())}function _e(i,t){if(i&1){let e=E();r(0,"div",2)(1,"div",3)(2,"strong"),m(3),n(),r(4,"div",4)(5,"button",5),h("click",function(){let a=C(e).$implicit,l=p();return x(l.editZone(a.id))}),m(6,"Editar"),n(),r(7,"button",6),h("click",function(){let a=C(e).$implicit,l=p();return x(l.deleteZone(a.id))}),m(8,"Borrar"),n()()(),g(9,be,4,1)(10,ve,1,1,"app-map-polygon-preview",7)(11,ye,2,0,"p",8),n()}if(i&2){let e=t.$implicit;s(3),v(e.name),s(6),N(e.description?9:-1),s(),N(e.coordinates&&e.coordinates.length>3?10:11)}}var F=class i{constructor(t){this.router=t}zones=[];onDelete=new Q;neighborhoodName="(Desconocido)";error=null;editZone(t){let e=this.zones.find(o=>o.id===t);if(!e){this.error="No se encontr\xF3 la zona para editar.";return}this.router.navigate([_.Admin.Neighborhoods.Zones.Edit(e.neighborhoodId,t)],{state:{neighborhoodName:this.neighborhoodName}})}deleteZone(t){let e=this.zones.find(o=>o.id===t);if(!e){this.error="Zona no encontrada para borrar.";return}confirm("\xBFEst\xE1 seguro que quiere eliminar la zona?")&&this.onDelete.emit({zoneId:t,neighborhoodId:e.neighborhoodId})}static \u0275fac=function(e){return new(e||i)(c(z))};static \u0275cmp=f({type:i,selectors:[["app-zone-list"]],inputs:{zones:"zones",neighborhoodName:"neighborhoodName"},outputs:{onDelete:"onDelete"},decls:2,vars:1,consts:[[1,"zone-list"],["class","zone-card",4,"ngFor","ngForOf"],[1,"zone-card"],[1,"zone-card-header"],[1,"buttons"],[1,"button","is-info","is-small",3,"click"],["type","button",1,"button","is-danger","is-small",3,"click"],["height","160px",3,"coordinates"],[1,"has-text-grey","mt-3"],[1,"zone-description"]],template:function(e,o){e&1&&(r(0,"div",0),g(1,_e,12,3,"div",1),n()),e&2&&(s(),d("ngForOf",o.zones))},dependencies:[b,J,L,V],styles:[".zone-list[_ngcontent-%COMP%]{margin-top:1rem}.zone-card[_ngcontent-%COMP%]{padding:1rem;border-top:4px solid #e0e0e0;border-left:4px solid #00c4a7;background-color:#fdfdfd;display:flex;flex-direction:column;justify-content:space-between}.zone-card[_ngcontent-%COMP%]   .zone-card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.zone-card[_ngcontent-%COMP%]   .zone-card-header[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:1rem}.zone-card[_ngcontent-%COMP%]   .zone-card-header[_ngcontent-%COMP%]   .buttons[_ngcontent-%COMP%]{display:flex;gap:.5rem}.zone-card[_ngcontent-%COMP%]   .zone-description[_ngcontent-%COMP%]{margin-top:.5rem;font-size:.85rem;color:#666}"]})};function Ce(i,t){i&1&&(r(0,"div"),m(1,"Cargando..."),n())}function xe(i,t){if(i&1&&(r(0,"div",8),m(1),n()),i&2){let e=p();s(),v(e.error)}}function Ie(i,t){if(i&1&&u(0,"app-map-polygon-preview",16),i&2){let e=p().$implicit;d("coordinates",e.geolocation)}}function Ne(i,t){i&1&&(r(0,"p",17),m(1,"Sin coordenadas."),n())}function Ee(i,t){if(i&1){let e=E();r(0,"p",17),m(1,"Zonas:"),n(),r(2,"app-zone-list",18),h("onDelete",function(a){C(e);let l=p(3);return x(l.deleteZone(a))}),n()}if(i&2){let e=p(2).$implicit,o=p();s(2),d("zones",o.zones[e.id])("neighborhoodName",e.name)}}function we(i,t){i&1&&(r(0,"p",17),m(1,"No hay zonas"),n())}function ze(i,t){if(i&1&&g(0,Ee,3,2)(1,we,2,0,"p",17),i&2){let e=p().$implicit,o=p();N(o.zones[e.id]&&o.zones[e.id].length!=0?0:1)}}function Le(i,t){if(i&1){let e=E();r(0,"div",9)(1,"div",10)(2,"strong"),m(3),n(),r(4,"div",11)(5,"button",12),h("click",function(){let a=C(e).$implicit,l=p();return x(l.toggleZones(a.id))}),m(6,"Zonas"),n(),r(7,"button",13),h("click",function(){let a=C(e).$implicit,l=p();return x(l.goToEdit(a.id))}),m(8,"Editar"),n(),r(9,"button",14),h("click",function(){let a=C(e).$implicit,l=p();return x(l.deleteNeighborhood(a.id))}),m(10,"Borrar"),n()()(),r(11,"p",15),m(12),n(),g(13,Ie,1,1,"app-map-polygon-preview",16)(14,Ne,2,0,"p",17)(15,ze,2,1),n()}if(i&2){let e=t.$implicit,o=p();s(3),v(e.name),s(9),v(e.description),s(),N(e.geolocation&&e.geolocation.length>3?13:14),s(2),N(o.expandedNeighborhoodId===e.id?15:-1)}}function Se(i,t){i&1&&(r(0,"p",15),m(1," No se encontraron barrios. "),n())}var oe=class i{constructor(t,e,o){this.neighborhoodService=t;this.zoneService=e;this.router=o}neighborhoods=[];loading=!0;error=null;zones={};loadingZones={};expandedNeighborhoodId=null;ngOnInit(){this.fetchNeighborhoods()}fetchNeighborhoods(){this.loading=!0,this.neighborhoodService.getAll().subscribe({next:t=>{this.neighborhoods=t,this.loading=!1},error:t=>{this.error="Error al cargar los barrios",this.loading=!1,console.error(t)}})}goToNew(){this.router.navigate([_.Admin.Neighborhoods.New])}goToEdit(t){let e=this.zones[t]??[];this.router.navigate([_.Admin.Neighborhoods.Edit(t)],{state:{zones:e}})}deleteNeighborhood(t){confirm("\xBFEst\xE1 seguro que quiere eliminar el barrio?")&&this.neighborhoodService.delete(t).subscribe({next:()=>this.fetchNeighborhoods(),error:e=>{this.error="Error eliminando el barrio",console.error(e)}})}toggleZones(t){if(this.expandedNeighborhoodId===t){this.expandedNeighborhoodId=null;return}this.expandedNeighborhoodId=t,this.zones[t]||(this.loadingZones[t]=!0,this.zoneService.getByNeighborhood(t).subscribe({next:e=>{let a=this.neighborhoods.find(l=>l.id===t)?.name??"(Desconocido)";this.zones[t]=e.map(l=>re(P({},l),{_neighborhoodName:a})),this.loadingZones[t]=!1},error:e=>{this.loadingZones[t]=!1,this.error="Error al cargar las zonas"}}))}deleteZone(t){this.zoneService.delete(t.neighborhoodId,t.zoneId).subscribe({next:()=>{let e=this.zones[t.neighborhoodId].findIndex(o=>o.id===t.zoneId);e>-1&&this.zones[t.neighborhoodId].splice(e,1)},error:e=>{this.error="Error eliminando la zona",console.error(e)}})}static \u0275fac=function(e){return new(e||i)(c(T),c(k),c(z))};static \u0275cmp=f({type:i,selectors:[["app-neighborhood-list"]],decls:10,vars:4,consts:[[1,"section"],[1,"container"],[1,"title"],[1,"button","is-primary","mb-4",3,"click"],[4,"ngIf"],["class","notification is-danger",4,"ngIf"],["class","box",4,"ngFor","ngForOf"],["class","has-text-grey",4,"ngIf"],[1,"notification","is-danger"],[1,"box"],[1,"is-flex","is-justify-content-space-between","is-align-items-center","mb-2"],[1,"buttons"],[1,"button","is-success","is-small",3,"click"],[1,"button","is-info","is-small",3,"click"],[1,"button","is-danger","is-small",3,"click"],[1,"has-text-grey"],["height","160px",3,"coordinates"],[1,"has-text-grey","mt-3"],[3,"onDelete","zones","neighborhoodName"]],template:function(e,o){e&1&&(r(0,"section",0)(1,"div",1)(2,"h1",2),m(3,"Barrios"),n(),r(4,"button",3),h("click",function(){return o.goToNew()}),m(5,"+ Agregar barrio"),n(),g(6,Ce,2,0,"div",4)(7,xe,2,1,"div",5)(8,Le,16,4,"div",6)(9,Se,2,0,"p",7),n()()),e&2&&(s(6),d("ngIf",o.loading),s(),d("ngIf",o.error),s(),d("ngForOf",o.neighborhoods),s(),d("ngIf",!o.loading&&o.neighborhoods.length===0))},dependencies:[b,J,w,L,F,V],encapsulation:2})};function Fe(i,t){i&1&&(r(0,"p",7),m(1," El nombre es obligatorio. "),n())}var G=class i{formGroup;static \u0275fac=function(e){return new(e||i)};static \u0275cmp=f({type:i,selectors:[["app-entity-basic-fields"]],inputs:{formGroup:"formGroup"},decls:12,vars:2,consts:[[3,"formGroup"],[1,"field"],[1,"label"],[1,"control"],["type","text","formControlName","name","required","",1,"input"],["class","help is-danger",4,"ngIf"],["formControlName","description",1,"textarea"],[1,"help","is-danger"]],template:function(e,o){if(e&1&&(r(0,"div",0)(1,"div",1)(2,"label",2),m(3,"Nombre"),n(),r(4,"div",3),u(5,"input",4),n(),g(6,Fe,2,0,"p",5),n(),r(7,"div",1)(8,"label",2),m(9,"Descripci\xF3n"),n(),r(10,"div",3),u(11,"textarea",6),n()()()),e&2){let a;d("formGroup",o.formGroup),s(6),d("ngIf",((a=o.formGroup.get("name"))==null?null:a.invalid)&&((a=o.formGroup.get("name"))==null?null:a.touched))}},dependencies:[b,w,S,le,de,A,ce,D,pe],encapsulation:2})};var y=ae(he());var Ze=["mapEl"],j=class i{constructor(t){this.fb=t;y.Icon.Default.mergeOptions({iconRetinaUrl:"assets/leaflet/marker-icon-2x.png",iconUrl:"assets/leaflet/marker-icon.png",shadowUrl:"assets/leaflet/marker-shadow.png"})}formArray;height="420px";minVertices=3;initialCenter=[-34.9205,-57.9536];initialZoom=14;mapEl;map;drawnItems=new y.FeatureGroup;drawControl;polygonLayer=null;sub;ngOnInit(){this.sub=this.formArray.valueChanges.subscribe(()=>this.renderFromForm())}ngAfterViewInit(){return se(this,null,function*(){window.L=y,yield import("./chunk-HOA3L3C5.js"),this.map=y.map(this.mapEl.nativeElement,{center:this.initialCenter,zoom:this.initialZoom}),y.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"\xA9 OpenStreetMap contributors"}).addTo(this.map),this.drawnItems.addTo(this.map),this.drawControl=new y.Control.Draw({draw:{polygon:{allowIntersection:!1,showArea:!0,guidelineDistance:10,shapeOptions:{weight:2},repeatMode:!1},marker:!1,polyline:!1,rectangle:!1,circle:!1,circlemarker:!1},edit:{featureGroup:this.drawnItems,remove:!0}}),this.map.addControl(this.drawControl),this.map.on("draw:created",t=>{let e=t.layer;this.polygonLayer&&this.drawnItems.removeLayer(this.polygonLayer),this.polygonLayer=e,this.drawnItems.addLayer(this.polygonLayer),this.syncFormFromPolygon(),this.fitBounds()}),this.map.on("draw:edited",()=>this.syncFormFromPolygon()),this.map.on("draw:deleted",()=>{this.polygonLayer=null,this.formArray.clear()}),this.renderFromForm()})}ngOnDestroy(){this.sub?.unsubscribe(),this.map&&this.map.remove()}renderFromForm(){if(!this.formArray)return;let t=[];for(let e=0;e<this.formArray.length;e++){let o=this.formArray.at(e),a=o.get("lat")?.value,l=o.get("lng")?.value;a!=null&&l!=null&&t.push({lat:+a,lng:+l})}if(t.length<this.minVertices){this.polygonLayer&&(this.drawnItems.removeLayer(this.polygonLayer),this.polygonLayer=null);return}this.polygonLayer?this.polygonLayer.setLatLngs(t):(this.polygonLayer=y.polygon(t,{weight:2}),this.drawnItems.addLayer(this.polygonLayer),this.fitBounds())}fitBounds(){this.polygonLayer&&this.map.fitBounds(this.polygonLayer.getBounds(),{padding:[20,20]})}syncFormFromPolygon(){if(!this.polygonLayer)return;let t=this.polygonLayer.getLatLngs()[0];if(!t||t.length<this.minVertices){this.formArray.clear();return}let e=this.formArray.length,o=t.length,a=Math.min(e,o);for(let l=0;l<a;l++)this.formArray.at(l).patchValue({lat:+t[l].lat,lng:+t[l].lng},{emitEvent:!1});for(let l=e;l<o;l++)this.formArray.push(this.fb.group({id:[null],lat:[+t[l].lat],lng:[+t[l].lng]}),{emitEvent:!1});for(let l=e-1;l>=o;l--)this.formArray.removeAt(l,{emitEvent:!1})}static \u0275fac=function(e){return new(e||i)(c(O))};static \u0275cmp=f({type:i,selectors:[["app-map-polygon-picker"]],viewQuery:function(e,o){if(e&1&&H(Ze,7),e&2){let a;W(a=Y())&&(o.mapEl=a.first)}},inputs:{formArray:"formArray",height:"height",minVertices:"minVertices",initialCenter:"initialCenter",initialZoom:"initialZoom"},decls:5,vars:3,consts:[["mapEl",""],[1,"map-wrapper"],[1,"map-host"],[1,"help","is-info","mt-2"]],template:function(e,o){e&1&&(r(0,"div",1),u(1,"div",2,0),n(),r(3,"p",3),m(4),n()),e&2&&(U("height",o.height),s(4),Z(" Dibuj\xE1 el pol\xEDgono con el bot\xF3n \u201CPolygon\u201D, pod\xE9s editar v\xE9rtices y borrar. M\xEDnimo ",o.minVertices," puntos. "))},dependencies:[b,S],styles:[".map-wrapper[_ngcontent-%COMP%]{position:relative;width:100%}.map-host[_ngcontent-%COMP%]{position:absolute;inset:0}.leaflet-container[_ngcontent-%COMP%]{font:inherit}"]})};function Me(i,t){if(i&1&&(r(0,"div",13),m(1),n()),i&2){let e=p();s(),v(e.error)}}function Pe(i,t){if(i&1){let e=E();r(0,"p",19),m(1,"Zonas:"),n(),r(2,"app-zone-list",20),h("onDelete",function(a){C(e);let l=p(2);return x(l.deleteZone(a))}),n()}if(i&2){let e=p(2);s(2),d("zones",e.zones)("neighborhoodName",e.form.value.name)}}function Ae(i,t){if(i&1){let e=E();r(0,"div",14)(1,"h2",15),m(2,"Zonas del barrio"),n(),r(3,"div",16)(4,"p",17),m(5,"Listado de zonas asociadas"),n(),r(6,"button",18),h("click",function(){C(e);let a=p();return x(a.goToCreateZone())}),m(7,"+ Nueva zona"),n()(),g(8,Pe,3,2),n()}if(i&2){let e=p();s(8),N(e.zones.length!=0?8:-1)}}var q=class i{constructor(t,e,o,a,l){this.fb=t;this.route=e;this.router=o;this.neighborhoodService=a;this.zoneService=l}zones=[];form;isEdit=!1;neighborhoodId;error=null;ngOnInit(){this.form=this.fb.group({name:["",I.required],description:[""],geolocation:this.fb.array([],ee.minLengthArray(3))});let t=this.route.snapshot.paramMap.get("id");t&&(this.isEdit=!0,this.neighborhoodId=+t,this.loadNeighborhood(),this.zoneService.getByNeighborhood(this.neighborhoodId).subscribe({next:e=>{this.zones=e,history.state?.newZone&&history.replaceState({},"")},error:()=>{this.error="Error cargando zonas del barrio"}}))}get geolocation(){return this.form.get("geolocation")}loadNeighborhood(){this.neighborhoodService.getById(this.neighborhoodId).subscribe({next:t=>{for(this.form.patchValue({name:t.name,description:t.description});this.geolocation.length!==0;)this.geolocation.removeAt(0);t.geolocation.forEach(e=>{let o=this.fb.group({id:[e.id],lat:[e.lat,[I.required,I.pattern(/^[-+]?\d+(\.\d+)?$/)]],lng:[e.lng,[I.required,I.pattern(/^[-+]?\d+(\.\d+)?$/)]]});this.geolocation.push(o)})},error:()=>{this.error="No se pudo cargar el barrio."}})}onSubmit(){let t=P({},this.form.value);(this.isEdit?this.neighborhoodService.update(this.neighborhoodId,t):this.neighborhoodService.create(t)).subscribe({next:()=>{this.router.navigate([_.Admin.Neighborhoods.List])},error:o=>{o.status===409?this.error="El barrio con ese nombre ya existe":this.error="Error guardando el barrio",console.error(o)}})}cancel(){this.router.navigate([_.Admin.Neighborhoods.List])}goToCreateZone(){this.router.navigate([_.Admin.Neighborhoods.Zones.New(this.neighborhoodId)],{state:{neighborhoodName:this.form.get("name")?.value}})}deleteZone(t){this.zoneService.delete(t.neighborhoodId,t.zoneId).subscribe({next:()=>{this.zones=this.zones.filter(e=>e.id!==t.zoneId)},error:()=>{this.error="Error eliminando la zona"}})}static \u0275fac=function(e){return new(e||i)(c(O),c(K),c(z),c(T),c(k))};static \u0275cmp=f({type:i,selectors:[["app-neighborhood-form"]],decls:16,vars:9,consts:[[1,"section"],[1,"container"],[1,"title"],["class","notification is-danger",4,"ngIf"],[3,"ngSubmit","formGroup"],[3,"formGroup"],[1,"my-4"],[3,"formArray","height"],["class","mt-6",4,"ngIf"],[1,"field","mt-4"],[1,"buttons"],["type","submit",1,"button","is-primary",3,"disabled"],["type","button",1,"button","is-danger",3,"click"],[1,"notification","is-danger"],[1,"mt-6"],[1,"subtitle","is-5"],[1,"is-flex","is-justify-content-space-between","is-align-items-center","mb-3"],[1,"has-text-grey"],["type","button",1,"button","is-success","is-small",3,"click"],[1,"has-text-grey","mt-3"],[3,"onDelete","zones","neighborhoodName"]],template:function(e,o){e&1&&(r(0,"section",0)(1,"div",1)(2,"h1",2),m(3),n(),g(4,Me,2,1,"div",3),r(5,"form",4),h("ngSubmit",function(){return o.onSubmit()}),u(6,"app-entity-basic-fields",5)(7,"hr",6)(8,"app-map-polygon-picker",7),g(9,Ae,9,1,"div",8),r(10,"div",9)(11,"div",10)(12,"button",11),m(13),n(),r(14,"button",12),h("click",function(){return o.cancel()}),m(15,"Cancelar"),n()()()()()()),e&2&&(s(3),v(o.isEdit?"Editar barrio":"Nuevo barrio"),s(),d("ngIf",o.error),s(),d("formGroup",o.form),s(),d("formGroup",o.form),s(2),d("formArray",o.geolocation)("height","420px"),s(),d("ngIf",o.isEdit),s(3),d("disabled",o.form.invalid),s(),Z(" ",o.isEdit?"Actualizar":"Crear"," "))},dependencies:[b,w,S,X,A,D,L,F,G,j],encapsulation:2})};function De(i,t){if(i&1&&(r(0,"div",13),m(1),n()),i&2){let e=p();s(),v(e.error)}}var $=class i{constructor(t,e,o,a,l){this.fb=t;this.route=e;this.router=o;this.zoneService=a;this.neighborhoodService=l}neighborhoodId;zoneCreated=new Q;form;isEdit=!1;zoneId;loading=!1;error=null;neighborhoodName="(Desconocido)";ngOnInit(){this.form=this.fb.group({name:["",I.required],description:[""],geolocation:this.fb.array([],ee.minLengthArray(3))});let t=history.state,e=this.route.snapshot.paramMap.get("neighId");e&&(this.neighborhoodId=+e,t?.neighborhoodName?this.neighborhoodName=t.neighborhoodName:this.neighborhoodService.getById(this.neighborhoodId).subscribe({next:a=>this.neighborhoodName=a.name,error:()=>this.neighborhoodName="(Desconocido)"}));let o=this.route.snapshot.paramMap.get("zoneId");o&&(this.isEdit=!0,this.zoneId=+o,this.loadZone())}get geolocation(){return this.form.get("geolocation")}loadZone(){this.loading=!0,this.zoneService.getById(this.neighborhoodId,this.zoneId).subscribe({next:t=>{this.form.patchValue({name:t.name,description:t.description}),this.neighborhoodId=t.neighborhoodId,this.loading=!1,this.geolocation.clear(),t.coordinates.forEach(e=>{this.geolocation.push(this.fb.group({id:[e.id],lat:[e.lat,I.required],lng:[e.lng,I.required]}))})},error:()=>{this.error="No se pudo cargar la zona.",this.loading=!1}})}submit(){if(this.form.invalid)return;let t=P({},this.form.value),e={id:this.isEdit?this.zoneId:void 0,name:t.name,description:t.description,neighborhoodId:this.neighborhoodId,coordinates:t.geolocation.filter(a=>a.lat!=null&&a.lng!=null).map(a=>({id:a.id??null,lat:+a.lat,lng:+a.lng}))};(this.isEdit?this.zoneService.update(this.neighborhoodId,this.zoneId,e):this.zoneService.create(this.neighborhoodId,e)).subscribe({next:()=>{this.router.navigate([_.Admin.Neighborhoods.Edit(this.neighborhoodId)],{state:{newZone:e}})},error:a=>{a.status===409?this.error="Ya existe una zona con ese nombre en este barrio.":this.error="Error guardando la zona."}})}cancel(){this.router.navigate([_.Admin.Neighborhoods.Edit(this.neighborhoodId)])}static \u0275fac=function(e){return new(e||i)(c(O),c(K),c(z),c(k),c(T))};static \u0275cmp=f({type:i,selectors:[["app-zone-form"]],inputs:{neighborhoodId:"neighborhoodId"},outputs:{zoneCreated:"zoneCreated"},decls:17,vars:9,consts:[[1,"section"],[1,"container"],[1,"title"],[1,"subtitle"],["class","notification is-danger",4,"ngIf"],[3,"ngSubmit","formGroup"],[3,"formGroup"],[1,"my-4"],[3,"formArray","height"],[1,"field","mt-4"],[1,"buttons"],["type","submit",1,"button","is-primary",3,"disabled"],["type","button",1,"button","is-danger",3,"click"],[1,"notification","is-danger"]],template:function(e,o){e&1&&(r(0,"section",0)(1,"div",1)(2,"h1",2),m(3),n(),r(4,"h2",3),m(5),n(),g(6,De,2,1,"div",4),r(7,"form",5),h("ngSubmit",function(){return o.submit()}),u(8,"app-entity-basic-fields",6)(9,"hr",7)(10,"app-map-polygon-picker",8),r(11,"div",9)(12,"div",10)(13,"button",11),m(14),n(),r(15,"button",12),h("click",function(){return o.cancel()}),m(16,"Cancelar"),n()()()()()()),e&2&&(s(3),Z(" Barrio ",o.neighborhoodName,""),s(2),v(o.isEdit?"Editar zona":"Nueva zona"),s(),d("ngIf",o.error),s(),d("formGroup",o.form),s(),d("formGroup",o.form),s(2),d("formArray",o.geolocation)("height","420px"),s(3),d("disabled",o.form.invalid),s(),Z(" ",o.isEdit?"Actualizar":"Crear"," "))},dependencies:[b,w,S,X,A,D,L,j,G],encapsulation:2})};var Kt=[{path:"",component:oe},{path:"new",component:q},{path:":id/edit",component:q},{path:":neighId",children:[{path:"zones",component:F},{path:"zones/new",component:$},{path:"zones/:zoneId/edit",component:$}]}];export{Kt as neighborhoodRoutes};
