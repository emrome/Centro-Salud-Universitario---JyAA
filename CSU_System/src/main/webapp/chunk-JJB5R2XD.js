import{a as M}from"./chunk-5ZESFPG3.js";import{a as L}from"./chunk-ULAKRKGX.js";import{a as se}from"./chunk-T5CJBDVT.js";import{b as K,c as F,d as Q,e as W,g as X,i as ee,j as te,k as ie,l as ne,m as re,p as oe,q as Ee,r as ae}from"./chunk-4ZEEV3KU.js";import{a as be}from"./chunk-MC4TDR63.js";import{b as he,d as Y,h as N,i as B}from"./chunk-OLTWCF2P.js";import{$a as m,Ea as x,Ha as ge,Ja as f,K as ue,Ob as w,P as ve,Pa as A,Pb as D,Qa as c,Sa as Z,Sb as S,Ta as y,Ua as o,V as fe,Va as n,W as u,Wa as g,X as v,Xa as V,Ya as k,Za as h,_a as p,_b as _e,bc as Ce,ca as I,gb as G,hb as s,ib as C,jb as E,kb as H,sb as $,tb as U,ua as l,vb as J,ya as _}from"./chunk-ILAX3XGE.js";import{a as P}from"./chunk-FDERIQAA.js";var O=class r{transform(t){if(!t)return"";let[e,i,a]=t.split("-").map(Number),d=new Date(e,i-1,a);return new Intl.DateTimeFormat("es-AR",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(d)}static \u0275fac=function(e){return new(e||r)};static \u0275pipe=ge({name:"fullDateEs",type:r,pure:!0})};function Se(r,t){if(r&1&&(o(0,"span",18),s(1),n()),r&2){let e=t.$implicit;l(),C(e)}}function Ie(r,t){if(r&1&&(V(0),f(1,Se,2,1,"span",17),k()),r&2){let e=m().$implicit,i=m();l(),c("ngForOf",i.surveyorsByEvent[e.id])}}function Fe(r,t){r&1&&(o(0,"span",19),s(1,"(Sin encuestadores asignados)"),n())}function we(r,t){if(r&1){let e=h();o(0,"button",20),p("click",function(){u(e);let a=m().$implicit,d=m();return v(d.edit(a))}),o(1,"span",14),g(2,"i",21),n(),o(3,"span"),s(4,"Editar"),n()()}}function De(r,t){if(r&1){let e=h();o(0,"div",4)(1,"div",5)(2,"p",6)(3,"span",7),s(4,"\u{1F4C5}"),n(),o(5,"span",8),s(6),$(7,"fullDateEs"),n()(),o(8,"p",6)(9,"span",7),s(10,"\u{1F4CD}"),n(),o(11,"span",8),s(12,"Zona:"),n(),o(13,"span",9),s(14),n()(),o(15,"p",6)(16,"span",7),s(17,"\u{1F9CD}\u200D\u2642\uFE0F"),n(),o(18,"span",8),s(19,"Encuestadores:"),n()(),o(20,"p",10),f(21,Ie,2,1,"ng-container",11)(22,Fe,2,0,"ng-template",null,0,J),n(),o(24,"div",12)(25,"button",13),p("click",function(){let a=u(e).$implicit,d=m();return v(d.delete(a.id))}),o(26,"span",14),g(27,"i",15),n(),o(28,"span"),s(29,"Borrar"),n()(),f(30,we,5,0,"button",16),n()()()}if(r&2){let e=t.$implicit,i=G(23),a=m();l(6),C(U(7,5,e.date)),l(8),C(a.zonesByEvent[e.id]||"Zona desconocida"),l(7),c("ngIf",a.surveyorsByEvent[e.id]==null?null:a.surveyorsByEvent[e.id].length)("ngIfElse",i),l(9),y(a.isList?30:-1)}}var j=class r{events=[];onDelete=new I;onEdit=new I;isList=!1;error=null;surveyorsByEvent={};zonesByEvent={};constructor(){}delete(t){if(!this.events.find(i=>i.id===t)){this.error="Jornada no encontrada para borrar.";return}confirm("\xBFEst\xE1 seguro que quiere eliminar la jornada?")&&this.onDelete.emit(t)}edit(t){if(!this.isList){this.error="No se puede editar la jornada porque no est\xE1 en modo edici\xF3n.";return}this.onEdit.emit(t)}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=x({type:r,selectors:[["app-event-list"]],inputs:{events:"events",isList:"isList",surveyorsByEvent:"surveyorsByEvent",zonesByEvent:"zonesByEvent"},outputs:{onDelete:"onDelete",onEdit:"onEdit"},decls:3,vars:1,consts:[["noSurveyors",""],[1,"events-scroll","mt-2"],[1,"columns","is-multiline"],["class","column is-12-tablet is-6-desktop",4,"ngFor","ngForOf"],[1,"column","is-12-tablet","is-6-desktop"],[1,"box","mb-4","p-4","has-background-white-light"],[1,"is-flex","is-align-items-center","mb-2"],[1,"icon","mr-2"],[1,"has-text-weight"],[1,"tag","is-info","is-light","ml-2"],[1,"ml-5"],[4,"ngIf","ngIfElse"],[1,"buttons","is-flex","is-justify-content-flex-end","mt-2"],["type","button",1,"button","is-danger","is-light","is-small",3,"click"],[1,"icon"],[1,"fas","fa-trash"],["type","button",1,"button","is-primary","is-light","is-small"],["class","tag is-light mr-1 mb-1",4,"ngFor","ngForOf"],[1,"tag","is-light","mr-1","mb-1"],[1,"has-text-grey"],["type","button",1,"button","is-primary","is-light","is-small",3,"click"],[1,"fas","fa-pen"]],template:function(e,i){e&1&&(o(0,"div",1)(1,"div",2),f(2,De,31,7,"div",3),n()()),e&2&&(l(2),c("ngForOf",i.events))},dependencies:[S,w,D,O],styles:[".events-scroll[_ngcontent-%COMP%]{max-height:calc(100vh - 300px);overflow-y:auto;padding-right:.5rem;margin-top:1rem;border:1px solid #dbdbdb;border-radius:6px}.box[_ngcontent-%COMP%]:hover{box-shadow:0 4px 8px #0000000d}"]})};var T=class r{constructor(t){this.http=t}baseUrl=`${Ce.apiUrl}/campaign`;getByCampaignId(t){return this.http.get(`${this.baseUrl}/${t}/events`)}getById(t,e){return this.http.get(`${this.baseUrl}/${t}/events/${e}`)}create(t,e){return this.http.post(`${this.baseUrl}/${t}/events`,e)}update(t,e,i){return this.http.put(`${this.baseUrl}/${t}/events/${e}`,i)}delete(t,e){return this.http.delete(`${this.baseUrl}/${t}/events/${e}`)}getSurveyors(t,e){return this.http.get(`${this.baseUrl}/${t}/events/${e}/surveyors`)}static \u0275fac=function(e){return new(e||r)(ve(_e))};static \u0275prov=ue({token:r,factory:r.\u0275fac,providedIn:"root"})};function Ve(r,t){if(r&1&&(o(0,"div",17),s(1),n()),r&2){let e=m();l(),C(e.error)}}function ke(r,t){r&1&&(o(0,"p",18),s(1," La fecha debe estar dentro del per\xEDodo de la campa\xF1a. "),n())}function Ne(r,t){if(r&1&&(o(0,"option",19),s(1),n()),r&2){let e=t.$implicit;c("value",e.id),l(),C(e.name)}}function Be(r,t){if(r&1){let e=h();o(0,"label",20)(1,"input",21),p("change",function(a){u(e);let d=m();return v(d.onSurveyorCheckboxChange(a))}),n(),s(2),n()}if(r&2){let e=t.$implicit,i=m();l(),c("value",e.id)("checked",i.form.value.surveyorIds.includes(e.id)),l(),H(" ",e.firstName," ",e.lastName," ")}}function Le(r,t){r&1&&(o(0,"p",18),s(1," Debe asignar al menos un encuestador. "),n())}var me=class r{constructor(t,e,i,a,d){this.fb=t;this.zoneService=e;this.surveyorService=i;this.eventService=a;this.campaignService=d}campaignId;onCreate=new I;minDate;maxDate;eventToEdit=null;onUpdate=new I;form;zones=[];surveyors=[];error=null;ngOnInit(){this.form=this.fb.group({date:["",F.required],zoneId:[null,F.required],surveyorIds:[[],F.required]},{validators:[this.validateDateInRange(),this.validateAtLeastOneSurveyor()]}),this.eventToEdit&&(this.form.patchValue({date:this.eventToEdit.date,zoneId:this.eventToEdit.zoneId,surveyorIds:this.eventToEdit.surveyorIds}),this.form.markAsTouched(),this.form.markAsDirty()),this.campaignService.getById(this.campaignId).subscribe({next:t=>{this.zoneService.getByNeighborhood(t.neighborhoodId).subscribe({next:e=>this.zones=e,error:()=>this.error="Error cargando zonas"})},error:()=>this.error="Error cargando campa\xF1a"}),this.surveyorService.getAll().subscribe({next:t=>this.surveyors=t,error:()=>this.error="Error cargando encuestadores"})}ngOnChanges(t){(t.minDate||t.maxDate)&&this.form&&(this.form.setValidators(this.validateDateInRange()),this.form.updateValueAndValidity()),t.eventToEdit&&this.form&&this.eventToEdit&&(this.form.patchValue({date:this.eventToEdit.date,zoneId:this.eventToEdit.zoneId,surveyorIds:this.eventToEdit.surveyorIds}),this.form.markAsTouched(),this.form.markAsDirty())}onSubmit(){let t=P({},this.form.value);if(this.form.invalid){this.error="Datos inv\xE1lidos o fuera de rango de campa\xF1a";return}this.error=null,this.eventToEdit?this.eventService.update(this.campaignId,this.eventToEdit.id,t).subscribe({next:e=>{this.onUpdate.emit(e),this.resetForm()},error:e=>{this.error="Error al actualizar la jornada",console.error(e)}}):this.eventService.create(this.campaignId,t).subscribe({next:e=>{this.onCreate.emit(e),this.resetForm()},error:e=>{e.status===400?this.error="Datos inv\xE1lidos o fuera de rango de campa\xF1a":this.error="Error al crear la jornada",console.error(e)}})}resetForm(){this.form.reset({date:"",zoneId:null,surveyorIds:[]}),this.form.markAsUntouched(),this.form.markAsPristine()}onSurveyorCheckboxChange(t){let e=t.target,i=this.form.get("surveyorIds")?.value;e.checked?this.form.get("surveyorIds")?.setValue([...i,+e.value]):this.form.get("surveyorIds")?.setValue(i.filter(a=>a!==+e.value))}validateDateInRange(){return t=>{if(!this.minDate||!this.maxDate)return null;let e=t.get("date")?.value;if(!e)return null;let i=new Date(e),a=new Date(this.minDate),d=new Date(this.maxDate);return i<a||i>d?{dateOutOfRange:!0}:null}}validateAtLeastOneSurveyor(){return t=>{let e=t.get("surveyorIds")?.value;return Array.isArray(e)&&e.length===0?{noSurveyors:!0}:null}}static \u0275fac=function(e){return new(e||r)(_(oe),_(L),_(be),_(T),_(M))};static \u0275cmp=x({type:r,selectors:[["app-event-form"]],inputs:{campaignId:"campaignId",minDate:"minDate",maxDate:"maxDate",eventToEdit:"eventToEdit"},outputs:{onCreate:"onCreate",onUpdate:"onUpdate"},features:[fe],decls:29,vars:12,consts:[[1,"box","is-light"],[1,"subtitle","is-6","mb-3"],[3,"ngSubmit","formGroup"],["class","notification is-danger",4,"ngIf"],[1,"field"],[1,"label"],[1,"control"],["type","date","formControlName","date",1,"input"],["class","help is-danger",4,"ngIf"],[1,"select","is-fullwidth"],["formControlName","zoneId"],["disabled","",3,"ngValue"],[3,"value",4,"ngFor","ngForOf"],[1,"box",2,"max-height","12em","overflow-y","auto"],["class","checkbox is-block mb-1",4,"ngFor","ngForOf"],[1,"buttons"],["type","submit",1,"button","is-primary",3,"disabled"],[1,"notification","is-danger"],[1,"help","is-danger"],[3,"value"],[1,"checkbox","is-block","mb-1"],["type","checkbox",3,"change","value","checked"]],template:function(e,i){if(e&1&&(o(0,"div",0)(1,"h2",1),s(2),n(),o(3,"form",2),p("ngSubmit",function(){return i.onSubmit()}),f(4,Ve,2,1,"div",3),o(5,"div",4)(6,"label",5),s(7,"Fecha"),n(),o(8,"div",6),g(9,"input",7),n(),f(10,ke,2,0,"p",8),n(),o(11,"div",4)(12,"label",5),s(13,"Zona"),n(),o(14,"div",9)(15,"select",10)(16,"option",11),s(17,"Seleccionar zona"),n(),f(18,Ne,2,2,"option",12),n()()(),o(19,"div",4)(20,"label",5),s(21,"Encuestadores"),n(),o(22,"div",6)(23,"div",13),f(24,Be,3,4,"label",14),n()(),f(25,Le,2,0,"p",8),n(),o(26,"div",15)(27,"button",16),s(28),n()()()()),e&2){let a;l(2),C(i.eventToEdit?"Editar jornada":"Nueva jornada"),l(),c("formGroup",i.form),l(),c("ngIf",i.error),l(5),A("min",i.minDate)("max",i.maxDate),l(),c("ngIf",(i.form.errors==null?null:i.form.errors.dateOutOfRange)&&((a=i.form.get("date"))==null?null:a.touched)),l(6),c("ngValue",null),l(2),c("ngForOf",i.zones),l(6),c("ngForOf",i.surveyors),l(),c("ngIf",i.form.errors==null?null:i.form.errors.noSurveyors),l(2),c("disabled",i.form.invalid),l(),E(" ",i.eventToEdit?"Guardar cambios":"Crear jornada"," ")}},dependencies:[S,w,D,ae,X,ne,re,K,ie,Q,W,ee,te,Ee],encapsulation:2})};var R=class r{survey;uploadRequested=new I;deleteRequested=new I;deleteSurvey(){confirm("\xBFEst\xE1 seguro de que desea eliminar esta encuesta?")&&this.deleteRequested.emit()}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=x({type:r,selectors:[["app-survey-info-box"]],inputs:{survey:"survey"},outputs:{uploadRequested:"uploadRequested",deleteRequested:"deleteRequested"},decls:13,vars:2,consts:[[1,"field"],[1,"label"],[1,"box","has-background-light","is-flex","is-justify-content-space-between","is-align-items-center"],[1,"icon","mr-2"],[1,"fas","fa-poll"],[1,"has-text-grey","is-size-7"],[1,"buttons"],["type","button",1,"button","is-danger","is-small",3,"click"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"label",1),s(2,"Encuesta asociada"),n(),o(3,"div",2)(4,"div")(5,"span",3),g(6,"i",4),n(),s(7),o(8,"span",5),s(9),n()(),o(10,"div",6)(11,"button",7),p("click",function(){return i.deleteSurvey()}),s(12," Borrar "),n()()()()),e&2&&(l(7),E(" ",i.survey.name," "),l(2),E("(",i.survey.uploadDate,")"))},dependencies:[S,N],encapsulation:2})};function ze(r,t){r&1&&(o(0,"div"),s(1,"Cargando campa\xF1as..."),n())}function je(r,t){if(r&1&&(o(0,"div",8),s(1),n()),r&2){let e=m();l(),C(e.error)}}function Re(r,t){r&1&&(o(0,"div",9),s(1," No se encontraron campa\xF1as. "),n())}function Ae(r,t){if(r&1){let e=h();o(0,"app-event-form",31),p("onCreate",function(a){u(e);let d=m(2).$implicit,b=m();return v(b.addEvent(a,d.id))})("onUpdate",function(a){u(e);let d=m(2).$implicit,b=m();return v(b.updateEvent(a,d.id))}),n()}if(r&2){let e=m(2).$implicit,i=m();c("campaignId",e.id)("minDate",e.startDate)("maxDate",e.endDate)("eventToEdit",i.eventToEditMap[e.id])}}function $e(r,t){if(r&1){let e=h();o(0,"app-event-list",32),p("onDelete",function(a){u(e);let d=m(2).$implicit,b=m();return v(b.deleteEvent(a,d.id))})("onEdit",function(a){u(e);let d=m(2).$implicit,b=m();return v(b.editEvent(a,d.id))}),n()}if(r&2){let e=m(2).$implicit,i=m();c("events",i.events[e.id])("zonesByEvent",i.zonesByEvent)("surveyorsByEvent",i.surveyorsByEvent)("isList",i.isList)}}function Ue(r,t){r&1&&(o(0,"p",27),s(1,"Cargando jornadas..."),n())}function qe(r,t){r&1&&(o(0,"p",27),s(1,"No hay jornadas asociadas."),n())}function Pe(r,t){if(r&1){let e=h();o(0,"p",27),s(1,"Jornadas:"),n(),o(2,"button",28),p("click",function(){u(e);let a=m().$implicit,d=m();return v(d.toggleEventForm(a.id))}),s(3),n(),f(4,Ae,1,4,"app-event-form",29)(5,$e,1,4,"app-event-list",30)(6,Ue,2,0,"p",27)(7,qe,2,0,"p",27)}if(r&2){let e=m().$implicit,i=m();l(3),E(" ",i.showEventForm[e.id]?"Ocultar jornada":"A\xF1adir jornada"," "),l(),y(i.showEventForm[e.id]?4:-1),l(),y(i.events[e.id]&&i.events[e.id].length!=0?5:i.loadingEvents[e.id]?6:7)}}function Ze(r,t){if(r&1){let e=h();V(0),o(1,"app-survey-info-box",33),p("deleteRequested",function(){u(e);let a=m().$implicit,d=m();return v(d.deleteSurvey(a.id))}),n(),k()}if(r&2){let e=t.ngIf;l(),c("survey",e)}}function Ge(r,t){if(r&1){let e=h();o(0,"div",10)(1,"div",11)(2,"p",12),s(3),n(),o(4,"div",13)(5,"button",14),p("click",function(){let a=u(e).$implicit,d=m();return v(d.toggleEvents(a.id))}),o(6,"span",15),g(7,"i",16),n(),o(8,"span"),s(9,"Jornadas"),n()(),o(10,"div",17)(11,"button",18),p("click",function(){let a=u(e).$implicit,d=m();return v(d.goToEditCampaign(a.id))}),o(12,"span",15),g(13,"i",19),n(),o(14,"span"),s(15,"Editar"),n()(),o(16,"div",20),s(17,"Tambi\xE9n pod\xE9s importar la encuesta"),n()(),o(18,"button",21),p("click",function(){let a=u(e).$implicit,d=m();return v(d.deleteCampaign(a.id))}),o(19,"span",15),g(20,"i",22),n(),o(21,"span"),s(22,"Borrar"),n()()()(),o(23,"p",23),g(24,"i",24),s(25),$(26,"fullDateEs"),$(27,"fullDateEs"),n(),o(28,"p",23),g(29,"i",25),s(30),n(),o(31,"div",26),f(32,Pe,8,3),n(),f(33,Ze,2,1,"ng-container",4),n()}if(r&2){let e=t.$implicit,i=m();l(3),C(e.name),l(22),H(" Desde: ",U(26,6,e.startDate)," | Hasta: ",U(27,8,e.endDate)," "),l(5),E(" Barrio: ",i.neighborhoods[e.neighborhoodId]," "),l(2),y(i.expandedCampaignId===e.id?32:-1),l(),c("ngIf",e==null?null:e.survey)}}var de=class r{constructor(t,e,i,a,d){this.campaignService=t;this.eventService=e;this.router=i;this.neighborhoodService=a;this.zoneService=d}campaigns=[];events={};loadingEvents={};neighborhoods={};zonesByEvent={};surveyorsByEvent={};expandedCampaignId=null;showEventForm={};eventToEditMap={};loading=!0;error=null;isList=!0;ngOnInit(){this.fetchCampaigns(),this.fetchNeighborhoods()}fetchCampaigns(){this.campaignService.getAll().subscribe({next:t=>{this.campaigns=t,this.loading=!1},error:t=>{this.error="Error cargando campa\xF1as",this.loading=!1}})}toggleEvents(t){if(this.expandedCampaignId===t){this.expandedCampaignId=null;return}this.expandedCampaignId=t,this.events[t]||(this.loadingEvents[t]=!0,this.eventService.getByCampaignId(t).subscribe({next:e=>{this.events[t]=e,this.showEventForm[t]=!1,this.loadingEvents[t]=!1;let i=this.campaigns.find(a=>a.id===t);i&&e.forEach(a=>{this.fetchZoneNameByEvent(i.neighborhoodId,a.zoneId,a.id),this.fetchSurveyorsByEvent(t,a.id)})},error:e=>{this.error="Error al cargar jornadas",this.loadingEvents[t]=!1,console.error(e)}}))}goToNewCampaign(){this.router.navigate([B.Admin.Campaigns.New])}goToEditCampaign(t){this.router.navigate([B.Admin.Campaigns.Edit(t)])}deleteCampaign(t){confirm("\xBFEliminar campa\xF1a?")&&this.campaignService.delete(t).subscribe({next:()=>this.fetchCampaigns(),error:e=>{this.error="Error eliminando campa\xF1a",console.error(e)}})}deleteEvent(t,e){this.events[e]&&this.eventService.delete(e,t).subscribe({next:()=>{this.events[e]=this.events[e].filter(i=>i.id!==t)},error:i=>{this.error="Error eliminando jornada",console.error(i)}})}fetchNeighborhoods(){this.neighborhoodService.getAll().subscribe({next:t=>{for(let e of t)this.neighborhoods[e.id]=e.name},error:t=>{console.error("Error cargando barrios",t)}})}toggleEventForm(t){this.showEventForm[t]=!this.showEventForm[t],this.showEventForm[t]?this.eventToEditMap[t]=null:this.resetEventForm(t)}fetchZoneNameByEvent(t,e,i){this.zoneService.getById(t,e).subscribe({next:a=>{this.zonesByEvent[i]=a.name},error:a=>{this.zonesByEvent[i]="Zona desconocida",console.error("Error cargando zona",a)}})}fetchSurveyorsByEvent(t,e){this.eventService.getSurveyors(t,e).subscribe({next:i=>{this.surveyorsByEvent[e]=i.map(a=>`${a.firstName} ${a.lastName}`)},error:i=>console.error("Error cargando encuestadores",i)})}addEvent(t,e){this.events[e].push(t);let i=this.campaigns.find(a=>a.id===e);i&&(this.fetchZoneNameByEvent(i.neighborhoodId,t.zoneId,t.id),this.fetchSurveyorsByEvent(e,t.id)),this.showEventForm[e]=!1}updateEvent(t,e){let i=this.events[e],a=i.findIndex(d=>d.id===t.id);if(a!==-1){i[a]=t;let d=this.campaigns.find(b=>b.id===e);d&&(this.fetchZoneNameByEvent(d.neighborhoodId,t.zoneId,t.id),this.fetchSurveyorsByEvent(e,t.id))}this.resetEventForm(e)}editEvent(t,e){this.eventToEditMap[e]=t,this.showEventForm[e]=!0}resetEventForm(t){this.eventToEditMap[t]=null,this.showEventForm[t]=!1}deleteSurvey(t){this.campaignService.deleteSurvey(t).subscribe({next:()=>{let e=this.campaigns.find(i=>i.id===t);e&&(e.survey=void 0)},error:()=>{this.error="Error al eliminar la encuesta."}})}static \u0275fac=function(e){return new(e||r)(_(M),_(T),_(Y),_(se),_(L))};static \u0275cmp=x({type:r,selectors:[["app-campaign-list"]],decls:10,vars:4,consts:[[1,"section"],[1,"container"],[1,"title"],[1,"button","is-primary","mb-4",3,"click"],[4,"ngIf"],["class","notification is-danger",4,"ngIf"],["class","has-text-grey",4,"ngIf"],["class","box",4,"ngFor","ngForOf"],[1,"notification","is-danger"],[1,"has-text-grey"],[1,"box"],[1,"is-flex","is-justify-content-space-between","is-align-items-center","mb-2"],[1,"title","is-5","has-text-weight-semibold","mb-1"],[1,"buttons","is-right"],["type","button",1,"button","is-light","is-small",3,"click"],[1,"icon"],[1,"fas","fa-calendar-alt"],[1,"tooltip-container"],["type","button",1,"button","is-info","is-small",3,"click"],[1,"fas","fa-edit"],[1,"tooltip"],["type","button",1,"button","is-danger","is-small",3,"click"],[1,"fas","fa-trash-alt"],[1,"is-size-10","has-text-grey-dark"],[1,"fas","fa-calendar-alt","mr-1"],[1,"fas","fa-map-marker-alt","mr-1"],[1,"field"],[1,"has-text-grey","mt-2"],["type","button",1,"button","is-success","is-small","mt-2",3,"click"],[3,"campaignId","minDate","maxDate","eventToEdit"],[3,"events","zonesByEvent","surveyorsByEvent","isList"],[3,"onCreate","onUpdate","campaignId","minDate","maxDate","eventToEdit"],[3,"onDelete","onEdit","events","zonesByEvent","surveyorsByEvent","isList"],[3,"deleteRequested","survey"]],template:function(e,i){e&1&&(o(0,"section",0)(1,"div",1)(2,"h1",2),s(3,"Campa\xF1as"),n(),o(4,"button",3),p("click",function(){return i.goToNewCampaign()}),s(5,"+ Agregar campa\xF1a"),n(),f(6,ze,2,0,"div",4)(7,je,2,1,"div",5)(8,Re,2,0,"div",6)(9,Ge,34,10,"div",7),n()()),e&2&&(l(6),c("ngIf",i.loading),l(),c("ngIf",i.error),l(),c("ngIf",!i.loading&&i.campaigns.length===0),l(),c("ngForOf",i.campaigns))},dependencies:[S,w,D,N,j,me,O,R],styles:[".tooltip-container[_ngcontent-%COMP%]{position:relative;display:inline-block}.tooltip-container[_ngcontent-%COMP%]   .tooltip[_ngcontent-%COMP%]{visibility:hidden;background-color:#4a4a4a;color:#fff;text-align:center;border-radius:4px;padding:.5em;position:absolute;z-index:1;top:-2.5em;left:50%;transform:translate(-50%);font-size:.75rem;white-space:nowrap}.tooltip-container[_ngcontent-%COMP%]:hover   .tooltip[_ngcontent-%COMP%]{visibility:visible}"]})};function He(r,t){if(r&1&&(o(0,"div",23),s(1),n()),r&2){let e=m();l(),C(e.error)}}function Je(r,t){r&1&&(o(0,"p",24),s(1,"Requerido"),n())}function Ye(r,t){r&1&&(o(0,"p",24),s(1," La fecha de fin no puede ser anterior a la fecha de inicio. "),n())}function Ke(r,t){if(r&1&&(o(0,"p",24),s(1),n()),r&2){let e=m();l(),E(" La fecha de inicio no puede dejar afuera jornadas ya cargadas (primera jornada: ",e.earliestEventDate,"). ")}}function Qe(r,t){if(r&1&&(o(0,"p",24),s(1),n()),r&2){let e=m();l(),E(" La fecha de fin no puede dejar afuera jornadas ya cargadas (\xFAltima jornada: ",e.latestEventDate,"). ")}}function We(r,t){if(r&1&&(o(0,"div",16)(1,"div",6),s(2),n()()),r&2){let e=m();l(2),E(" ",e.getNeighborhoodName(e.form.value.neighborhoodId)," ")}}function Xe(r,t){if(r&1&&(o(0,"option",29),s(1),n()),r&2){let e=t.$implicit;c("value",e.id),l(),C(e.name)}}function et(r,t){r&1&&(o(0,"p",24),s(1,"Requerido"),n())}function tt(r,t){if(r&1&&(o(0,"div",25)(1,"select",26)(2,"option",27),s(3,"Seleccionar barrio"),n(),f(4,Xe,2,2,"option",28),n()(),f(5,et,2,0,"p",11)),r&2){let e,i=m();l(2),c("ngValue",null),l(2),c("ngForOf",i.neighborhoods),l(),c("ngIf",((e=i.form.get("neighborhoodId"))==null?null:e.invalid)&&((e=i.form.get("neighborhoodId"))==null?null:e.touched))}}function it(r,t){if(r&1){let e=h();o(0,"app-event-list",36),p("onDelete",function(a){u(e);let d=m(2);return v(d.deleteEvent(a))}),s(1," >"),n()}if(r&2){let e=m(2);c("events",e.events)("isList",!1)("zonesByEvent",e.zonesByEvent)("surveyorsByEvent",e.surveyorsByEvent)}}function nt(r,t){r&1&&(o(0,"p",17),s(1,"Cargando jornadas..."),n())}function rt(r,t){r&1&&(o(0,"p",17),s(1,"No hay jornadas asociadas."),n())}function ot(r,t){if(r&1){let e=h();o(0,"div",37)(1,"button",38),p("click",function(){u(e);let a=m(2);return v(a.successMessage=null)}),n(),s(2),n()}if(r&2){let e=m(2);l(2),E(" ",e.successMessage," ")}}function at(r,t){if(r&1){let e=h();o(0,"div",39)(1,"button",38),p("click",function(){u(e);let a=m(2);return v(a.errorMessage=null)}),n(),s(2),n()}if(r&2){let e=m(2);l(2),E(" ",e.errorMessage," ")}}function st(r,t){if(r&1){let e=h();V(0),o(1,"app-survey-info-box",40),p("deleteRequested",function(){u(e);let a=m(2);return v(a.deleteSurvey())}),n(),o(2,"button",41),p("click",function(){u(e);let a=m(2);return v(a.showUploadForm=!0)}),o(3,"span",42),g(4,"i",43),n(),o(5,"span"),s(6,"Reemplazar encuesta"),n()(),k()}if(r&2){let e=t.ngIf;l(),c("survey",e)}}function lt(r,t){if(r&1){let e=h();o(0,"div",44)(1,"p",45),s(2,"No hay encuesta importada"),n(),o(3,"button",46),p("click",function(){u(e);let a=m(2);return v(a.showUploadForm=!0)}),o(4,"span",42),g(5,"i",47),n(),o(6,"span"),s(7,"Importar encuesta"),n()()()}}function mt(r,t){if(r&1&&(o(0,"div",30)(1,"label",8),s(2,"Jornadas asociadas"),n(),o(3,"div",31)(4,"div",6),f(5,it,2,4,"app-event-list",32)(6,nt,2,0,"p",17)(7,rt,2,0,"p",17),n()()(),o(8,"div",31)(9,"div",6),f(10,ot,3,1,"div",33)(11,at,3,1,"div",34)(12,st,7,1,"ng-container",35)(13,lt,8,0,"ng-template",null,0,J),n()()),r&2){let e=G(14),i=m();l(5),y(i.events&&i.events.length!=0?5:i.loadingEvents?6:7),l(5),c("ngIf",i.successMessage),l(),c("ngIf",i.errorMessage),l(),c("ngIf",i.campaign==null?null:i.campaign.survey)("ngIfElse",e)}}function dt(r,t){r&1&&(o(0,"p",17),s(1,"Para agregar jornadas primero debes guardar la campa\xF1a."),n())}function ct(r,t){if(r&1){let e=h();o(0,"div",71)(1,"button",38),p("click",function(){u(e);let a=m(2);return v(a.uploadErrorMessage=!1)}),n(),o(2,"strong"),s(3,"No pudimos importar la encuesta."),n(),g(4,"br"),s(5," Verific\xE1 que los archivos sean CSV v\xE1lidos y correspondan a cada campo. Volv\xE9 a seleccionarlos e intent\xE1 de nuevo. "),n()}}function pt(r,t){if(r&1){let e=h();o(0,"div",48)(1,"div",49),p("click",function(){u(e);let a=m();return v(a.showUploadForm=!1)}),n(),o(2,"div",50)(3,"header",51)(4,"p",52)(5,"span",53),g(6,"i",54),n(),s(7," Importar encuesta "),n(),o(8,"button",55),p("click",function(){u(e);let a=m();return v(a.showUploadForm=!1)}),n()(),o(9,"section",56),f(10,ct,6,0,"div",57),o(11,"div",7)(12,"label",8),s(13,"Archivo CSV - Formulario (Form)"),n(),o(14,"div",58)(15,"label",59)(16,"input",60),p("change",function(a){u(e);let d=m();return v(d.onFileChange(a,"form"))}),n(),o(17,"span",61)(18,"span",62),g(19,"i",47),n(),o(20,"span",59),s(21,"Elegir archivo"),n()(),o(22,"span",63),s(23),n()()()(),o(24,"div",64)(25,"label",8),s(26,"Archivo CSV - Personas (Branch)"),n(),o(27,"div",58)(28,"label",59)(29,"input",60),p("change",function(a){u(e);let d=m();return v(d.onFileChange(a,"branch"))}),n(),o(30,"span",61)(31,"span",62),g(32,"i",47),n(),o(33,"span",59),s(34,"Elegir archivo"),n()(),o(35,"span",63),s(36),n()()()(),o(37,"div",65)(38,"div",66),s(39,' La importaci\xF3n se guarda inmediatamente y no requiere hacer clic en "Actualizar campa\xF1a". '),n()()(),o(40,"footer",67)(41,"button",68),p("click",function(){u(e);let a=m();return v(a.uploadSurvey())}),o(42,"span",42),g(43,"i",69),n(),o(44,"span"),s(45,"Subir encuesta"),n()(),o(46,"button",70),p("click",function(){u(e);let a=m();return v(a.showUploadForm=!1)}),s(47,"Cancelar"),n()()()()}if(r&2){let e,i,a=m();Z("is-active",a.showUploadForm),l(10),c("ngIf",a.uploadErrorMessage),l(13),C((e=a.formCsv==null?null:a.formCsv.name)!==null&&e!==void 0?e:"Ning\xFAn archivo seleccionado"),l(13),C((i=a.branchCsv==null?null:a.branchCsv.name)!==null&&i!==void 0?i:"Ning\xFAn archivo seleccionado"),l(5),Z("is-loading",a.isUploading),c("disabled",!a.formCsv||!a.branchCsv)}}var q=class r{constructor(t,e,i,a,d,b,ut){this.fb=t;this.campaignService=e;this.neighborhoodService=i;this.zoneService=a;this.eventService=d;this.route=b;this.router=ut}form;isEdit=!1;campaignId;campaign;loadingEvents=!1;events=[];surveyorsByEvent={};zonesByEvent={};neighborhoodId;error=null;neighborhoods=[];formCsv;branchCsv;showUploadForm=!1;successMessage=null;errorMessage=null;uploadErrorMessage=!1;isSubmitting=!1;isUploading=!1;earliestEventDate;latestEventDate;ngOnInit(){this.form=this.fb.group({name:["",F.required],startDate:["",F.required],endDate:["",F.required],neighborhoodId:[null,F.required]},{validators:[this.dateRangeValidator,this.dateMustCoverEvents()]});let t=this.route.snapshot.paramMap.get("id");t&&(this.isEdit=!0,this.campaignId=+t,this.loadCampaign()),this.loadNeighborhoods()}loadCampaign(){this.campaignService.getById(this.campaignId).subscribe({next:t=>{this.form.patchValue(t),this.campaign=t,this.loadEvents(),this.neighborhoodId=t.neighborhoodId},error:()=>this.error="Error al cargar la campa\xF1a"})}loadNeighborhoods(){this.neighborhoodService.getAll().subscribe({next:t=>this.neighborhoods=t,error:()=>this.error="Error cargando barrios"})}onSubmit(){this.isSubmitting=!0;let t=P({},this.form.value);(this.isEdit?this.campaignService.update(this.campaignId,t):this.campaignService.create(t)).subscribe({next:()=>{this.isSubmitting=!1,this.router.navigate([B.Admin.Campaigns.List])},error:i=>{this.isSubmitting=!1;let a=i?.error?.error||i?.error?.message;i.status===409?this.error="Ya existe una campa\xF1a con ese nombre":i.status===404?this.error="Barrio no encontrado":i.status===400&&a?.includes("jornadas fuera del nuevo rango")?this.error=a:i.status===400?this.error="Datos inv\xE1lidos o fuera de rango (fecha de inicio o fin)":this.error="Error guardando la campa\xF1a",console.error(i)}})}cancel(){this.router.navigate([B.Admin.Campaigns.List])}deleteEvent(t){this.eventService.delete(this.campaignId,t).subscribe({next:()=>this.loadEvents(),error:()=>this.error="Error eliminando evento"})}loadEvents(){this.loadingEvents=!0,this.eventService.getByCampaignId(this.campaignId).subscribe({next:t=>{if(this.events=t,this.events.length>0){let e=this.events.map(i=>i.date).filter(Boolean).sort();this.earliestEventDate=e[0],this.latestEventDate=e[e.length-1]}else this.earliestEventDate=void 0,this.latestEventDate=void 0;this.form.updateValueAndValidity({onlySelf:!1,emitEvent:!1});for(let e of this.events)this.loadZoneName(e),this.loadSurveyorNames(e);this.loadingEvents=!1},error:()=>{this.error="Error cargando eventos",this.loadingEvents=!1}})}dateMustCoverEvents(){return t=>{if(!this.isEdit||!this.events||this.events.length===0)return null;let e=t.get("startDate")?.value||null,i=t.get("endDate")?.value||null;if(!e||!i||!this.earliestEventDate||!this.latestEventDate)return null;let a={};return e>this.earliestEventDate&&(a.startExcludesEvents=!0),i<this.latestEventDate&&(a.endExcludesEvents=!0),Object.keys(a).length?a:null}}getNeighborhoodName(t){let e=this.neighborhoods.find(i=>i.id===t);return e?e.name:"Barrio desconocido"}loadSurveyorNames(t){this.eventService.getSurveyors(this.campaignId,t.id).subscribe({next:e=>{this.surveyorsByEvent[t.id]=e.map(i=>`${i.firstName} ${i.lastName}`)},error:()=>{this.surveyorsByEvent[t.id]=["Error al cargar encuestadores"]}})}loadZoneName(t){this.zoneService.getByNeighborhood(this.neighborhoodId).subscribe({next:e=>{let i=e.find(a=>a.id===t.zoneId);this.zonesByEvent[t.id]=i?i.name:"Zona desconocida"},error:()=>{this.zonesByEvent[t.id]="Error al cargar zona"}})}dateRangeValidator(t){let e=t.get("startDate")?.value,i=t.get("endDate")?.value;return e&&i&&i<e?{dateRangeInvalid:!0}:null}onFileChange(t,e){let i=t.target;i.files&&i.files.length>0&&(e==="form"?this.formCsv=i.files[0]:this.branchCsv=i.files[0])}uploadSurvey(){if(!this.formCsv||!this.branchCsv||!this.campaign){this.errorMessage="Faltan archivos o campa\xF1a no cargada";return}if(this.campaign.survey){if(!confirm("Ya existe una encuesta para esta campa\xF1a. \xBFDese\xE1s eliminarla para subir una nueva?"))return;this.deleteSurveyAndUpload()}else this.performUpload()}deleteSurvey(){this.campaignId&&this.campaignService.deleteSurvey(this.campaignId).subscribe({next:()=>{this.campaign.survey=void 0,this.successMessage="Encuesta eliminada correctamente."},error:()=>{this.errorMessage="Ocurri\xF3 un error al eliminar la encuesta."}})}deleteSurveyAndUpload(){this.campaignService.deleteSurvey(this.campaignId).subscribe({next:()=>{this.campaign.survey=void 0,this.successMessage="Encuesta anterior eliminada correctamente.",this.performUpload()},error:()=>{this.errorMessage="Error al eliminar la encuesta anterior."}})}performUpload(){this.isUploading=!0;let t=new FormData;t.append("formCsv",this.formCsv),t.append("branchCsv",this.branchCsv),t.append("campaignId",this.campaignId.toString()),t.append("campaignCode",this.campaign.name.replaceAll(" ","_").toLowerCase()),t.append("neighborhoodName",this.getNeighborhoodName(this.neighborhoodId).replaceAll(" ","_").toLowerCase()),this.successMessage=null,this.errorMessage=null,this.campaignService.importSurvey(this.campaignId,t).subscribe({next:()=>{this.isUploading=!1,this.successMessage="Encuesta importada correctamente",this.formCsv=void 0,this.branchCsv=void 0,this.showUploadForm=!1,this.loadCampaign()},error:()=>{this.isUploading=!1,this.uploadErrorMessage=!0}})}static \u0275fac=function(e){return new(e||r)(_(oe),_(M),_(se),_(L),_(T),_(he),_(Y))};static \u0275cmp=x({type:r,selectors:[["app-campaign-form"]],decls:44,vars:16,consts:[["noSurvey",""],[1,"section"],[1,"container"],[1,"title","has-text-centered"],["class","notification is-danger",4,"ngIf"],[1,"card",3,"ngSubmit","formGroup"],[1,"card-content"],[1,"field"],[1,"label"],[1,"control"],["type","text","formControlName","name",1,"input"],["class","help is-danger",4,"ngIf"],[1,"columns","is-mobile"],[1,"column"],["type","date","formControlName","startDate",1,"input"],["type","date","formControlName","endDate",1,"input"],[1,"card","has-background-light"],[1,"has-text-grey"],[1,"field","mt-5","has-text-centered"],[1,"buttons","is-centered"],["type","submit",1,"button","is-primary",3,"disabled"],["type","button",1,"button","is-light",3,"click"],["class","modal",3,"is-active",4,"ngIf"],[1,"notification","is-danger"],[1,"help","is-danger"],[1,"select","is-fullwidth"],["formControlName","neighborhoodId"],["disabled","",3,"ngValue"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"field","mt-5"],[1,"card"],[3,"events","isList","zonesByEvent","surveyorsByEvent"],["class","notification is-success is-light",4,"ngIf"],["class","notification is-danger is-light",4,"ngIf"],[4,"ngIf","ngIfElse"],[3,"onDelete","events","isList","zonesByEvent","surveyorsByEvent"],[1,"notification","is-success","is-light"],["type","button",1,"delete",3,"click"],[1,"notification","is-danger","is-light"],[3,"deleteRequested","survey"],["type","button",1,"button","is-warning","is-small","mt-3",3,"click"],[1,"icon"],[1,"fas","fa-sync"],[1,"has-text-centered","py-4"],[1,"has-text-grey","mb-3"],["type","button",1,"button","is-info",3,"click"],[1,"fas","fa-upload"],[1,"modal"],[1,"modal-background",3,"click"],[1,"modal-card"],[1,"modal-card-head"],[1,"modal-card-title"],[1,"icon","mr-2"],[1,"fas","fa-file-csv"],[1,"delete",3,"click"],[1,"modal-card-body"],["class","notification is-danger is-light","role","alert","aria-live","polite",4,"ngIf"],[1,"file","has-name","is-fullwidth"],[1,"file-label"],["type","file","accept",".csv",1,"file-input",3,"change"],[1,"file-cta"],[1,"file-icon"],[1,"file-name"],[1,"field","mt-4"],[1,"message","is-info","mt-4"],[1,"message-body","is-small"],[1,"modal-card-foot"],["type","button",1,"button","is-primary",3,"click","disabled"],[1,"fas","fa-paper-plane"],[1,"button",3,"click"],["role","alert","aria-live","polite",1,"notification","is-danger","is-light"]],template:function(e,i){if(e&1&&(o(0,"section",1)(1,"div",2)(2,"h1",3),s(3),n(),f(4,He,2,1,"div",4),o(5,"form",5),p("ngSubmit",function(){return i.onSubmit()}),o(6,"div",6)(7,"div",7)(8,"label",8),s(9,"Nombre de la campa\xF1a"),n(),o(10,"div",9),g(11,"input",10),n(),f(12,Je,2,0,"p",11),n(),o(13,"div",12)(14,"div",13)(15,"div",7)(16,"label",8),s(17,"Fecha de inicio"),n(),o(18,"div",9),g(19,"input",14),n()()(),o(20,"div",13)(21,"div",7)(22,"label",8),s(23,"Fecha de fin"),n(),o(24,"div",9),g(25,"input",15),n()()()(),f(26,Ye,2,0,"p",11)(27,Ke,2,1,"p",11)(28,Qe,2,1,"p",11),o(29,"div",7)(30,"label",8),s(31,"Barrio"),n(),o(32,"div",9),f(33,We,3,1,"div",16)(34,tt,6,3),n()(),f(35,mt,15,5)(36,dt,2,0,"p",17),o(37,"div",18)(38,"div",19)(39,"button",20),s(40),n(),o(41,"button",21),p("click",function(){return i.cancel()}),s(42," Cancelar "),n()()()()()()(),f(43,pt,48,8,"div",22)),e&2){let a,d,b;l(3),C(i.isEdit?"Editar campa\xF1a":"Nueva campa\xF1a"),l(),c("ngIf",i.error),l(),c("formGroup",i.form),l(7),c("ngIf",((a=i.form.get("name"))==null?null:a.invalid)&&((a=i.form.get("name"))==null?null:a.touched)),l(7),A("max",((d=i.form.get("endDate"))==null?null:d.value)||null),l(6),A("min",((b=i.form.get("startDate"))==null?null:b.value)||null),l(),c("ngIf",i.form.errors==null?null:i.form.errors.dateRangeInvalid),l(),c("ngIf",i.form.errors==null?null:i.form.errors.startExcludesEvents),l(),c("ngIf",i.form.errors==null?null:i.form.errors.endExcludesEvents),l(5),y(i.isEdit?33:34),l(2),y(i.isEdit?35:36),l(4),Z("is-loading",i.isSubmitting),c("disabled",i.form.invalid),l(),E(" ",i.isEdit?"Actualizar":"Crear"," "),l(3),c("ngIf",i.isEdit)}},dependencies:[S,w,D,ae,X,ne,re,K,ie,Q,W,ee,te,N,j,R],encapsulation:2})};var gi=[{path:"",component:de},{path:"new",component:q},{path:":id/edit",component:q}];export{gi as adminCampaignsRoutes};
